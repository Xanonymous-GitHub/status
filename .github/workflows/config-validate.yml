---

name: Validate Compose & Gatus config

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v6

      - name: Ensure config exists
        run: |
          set -euo pipefail
          test -f config/config.yaml

      - name: Validate compose + gatus config (with postgres)
        run: |
          set -euo pipefail

          cleanup() {
            # Always attempt to dump logs to help debugging, then tear down.
            docker compose -f compose.yml logs --no-color || true
            docker compose -f compose.yml down -v || true
          }
          trap cleanup EXIT

          # 1) Create .env for CI (dummy secrets or GitHub Secrets)
          cat > .env <<'EOF'
          POSTGRES_DB=gatus
          POSTGRES_USER=gatus
          POSTGRES_PASSWORD=ci_dummy_password
          GATUS_LOG_LEVEL=DEBUG
          EOF

          # 2) Static validation (resolve interpolation + compose model)
          docker compose -f compose.yml config --environment >/dev/null
          docker compose -f compose.yml config -q

          # 3) Boot stack (wait for healthchecks if supported)
          # NOTE: `--wait` implies detached mode and waits for services to be running/healthy.
          docker compose -f compose.yml up -d --wait

          # 4) Sanity check (gatus up)
          curl -fsS --retry 10 --retry-delay 1 --retry-connrefused http://127.0.0.1:8080/ >/dev/null
